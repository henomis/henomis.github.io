<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Running NATS on a FreeBSD Jail | Simone Vellei Blog</title><meta name=keywords content="nats,freebsd,jail,bastille,go"><meta name=description content="Last few months I played with FreeBSD and my Rock64 embedded boards [1] [2]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like bastille) making the whole experience more enjoyable."><meta name=author content="Simone Vellei"><link rel=canonical href=https://simonevellei.com/blog/posts/running-nats-on-a-freebsd-jail/><script>location.protocol!=="https:"&&(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.replace(`https:${location.href.substring(location.protocol.length)}`))</script><link crossorigin=anonymous href=/blog/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=preload href=/blog/apple-touch-icon.png as=image><script defer crossorigin=anonymous src=/blog/assets/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>@media screen and (min-width:769px){.post-content img.zoomCheck{cursor:zoom-in;transition:transform .3s ease;z-index:1;position:relative}.post-content img.zoomed{cursor:zoom-out;position:relative;z-index:999;transition:transform .3s ease}body.no-scroll{overflow:hidden}}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll(".post-content img.zoomCheck");e.forEach(e=>{e.addEventListener("click",function(){if(e.classList.contains("zoomed"))e.classList.remove("zoomed"),e.style.transform="scale(1)",document.body.classList.remove("no-scroll");else{const t=Math.min(e.naturalWidth/e.clientWidth,window.innerWidth/e.clientWidth,window.innerHeight/e.clientHeight);e.classList.add("zoomed"),e.style.transform=`scale(${t})`,document.body.classList.add("no-scroll")}})})})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Running NATS on a FreeBSD Jail"><meta property="og:description" content="Last few months I played with FreeBSD and my Rock64 embedded boards [1] [2]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like bastille) making the whole experience more enjoyable."><meta property="og:type" content="article"><meta property="og:url" content="https://simonevellei.com/blog/posts/running-nats-on-a-freebsd-jail/"><meta property="og:image" content="https://simonevellei.com/blog/images/nats001.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-01T15:26:03+01:00"><meta property="article:modified_time" content="2025-01-01T15:26:03+01:00"><meta property="og:site_name" content="Simone Vellei Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://simonevellei.com/blog/images/nats001.png"><meta name=twitter:title content="Running NATS on a FreeBSD Jail"><meta name=twitter:description content="Last few months I played with FreeBSD and my Rock64 embedded boards [1] [2]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like bastille) making the whole experience more enjoyable."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://simonevellei.com/blog/posts/"},{"@type":"ListItem","position":3,"name":"Running NATS on a FreeBSD Jail","item":"https://simonevellei.com/blog/posts/running-nats-on-a-freebsd-jail/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Running NATS on a FreeBSD Jail","name":"Running NATS on a FreeBSD Jail","description":"Last few months I played with FreeBSD and my Rock64 embedded boards [1] [2]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like bastille) making the whole experience more enjoyable.","keywords":["nats","freebsd","jail","bastille","go"],"articleBody":"Last few months I played with FreeBSD and my Rock64 embedded boards [1] [2]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like bastille) making the whole experience more enjoyable. To have a real example of a microservice running on a jail, I decided to try with NATS.\nWhat is NATS? NATS is an open-source messaging system that is designed for cloud-native applications, IoT messaging, and microservices architectures. It provides a lightweight, high-performance, and secure communication mechanism that supports both publish-subscribe and request-reply patterns. NATS is known for its simplicity, ease of use, and ability to scale horizontally, making it an ideal choice for distributed systems.\nOne of the key features of NATS is its ability to handle high-throughput and low-latency messaging. It achieves this through a combination of efficient protocol design, in-memory data structures, and optimized network communication. NATS also supports clustering, which allows multiple NATS servers to work together to provide fault tolerance and load balancing.\nIn addition to its core messaging capabilities, NATS has a rich ecosystem of clients and libraries for various programming languages, making it easy to integrate with different applications and services. It also offers advanced features such as streaming, persistence, and security, which can be leveraged to build robust and reliable messaging solutions.\nWhat is a FreeBSD jail? FreeBSD jails are a powerful and flexible feature of the FreeBSD operating system that allow you to create isolated, secure environments within a single FreeBSD instance. Introduced in FreeBSD 4.0, jails provide a lightweight alternative to full virtualization, enabling you to run multiple applications or services in separate, confined spaces without the overhead of a full virtual machine.\nA FreeBSD jail operates as a chroot environment with additional security and resource management features. Each jail has its own filesystem, network interfaces, and process space, ensuring that processes running inside a jail cannot interfere with those in other jails or the host system. This isolation makes jails an excellent choice for securely hosting multiple applications on a single server, testing software in a controlled environment, or managing multi-tenant environments.\nJails are highly configurable, allowing you to fine-tune the level of isolation and resource allocation for each jail. You can assign specific IP addresses, limit CPU and memory usage, and control access to system resources. This flexibility, combined with the lightweight nature of jails, makes them a popular choice for both development and production environments.\nWhat is Bastille? Bastille is a command-line utility for managing FreeBSD jails. It simplifies the process of creating, configuring, and maintaining jails, which are lightweight, isolated environments similar to containers. Bastille provides an easy-to-use interface for jail management, allowing users to quickly deploy and manage applications in a secure and efficient manner.\nWith Bastille, you can create new jails, start and stop them, and manage their configurations with simple commands. It also supports templates, which can be used to automate the deployment of pre-configured environments. This makes it an excellent tool for both development and production use cases, where consistency and repeatability are important.\nBastille also integrates with ZFS, a robust file system that provides advanced features such as snapshots and cloning. This integration allows for efficient storage management and easy rollback of changes, further enhancing the flexibility and reliability of your jail environments.\nImplementing a Bastille template for NATS Bastille templates are pre-configured environments that can be used to quickly deploy new jails. They contain a base FreeBSD installation along with any additional packages or configurations that you want to include. Templates are a powerful feature of Bastille that can help you streamline your workflow and ensure consistency across your environments.\nThe idea is to be architecture agnostic, so the template can be used in any FreeBSD system. NATS will be compiled from source, so the template will contain the necessary packages to build it.\n# install required packages PKG git PKG go Then we can create specific user and group for NATS:\n# create default group CMD pw groupadd \"${NATS_GROUP}\" # create default user CMD pw useradd -n \"${NATS_USER}\" -g \"${NATS_GROUP}\" -s /usr/sbin/nologin -w no We’ll accept group and user names as environment variables, so we can customize them when creating the jail from the template.\nNow it’s time to clone the NATS repository and compile it:\n# download and install nats server CMD \"${GO}\" install \"github.com/nats-io/nats-server/v2@${NATS_VERSION}\" CMD \"${INSTALL}\" -o \"${NATS_USER}\" -g \"${NATS_GROUP}\" \"${GOPATH}/bin/nats-server\" /usr/local/bin/nats-server We’ll use go install to download and compile the NATS server, and then we’ll install it in the /usr/local/bin directory. We’ll also set the owner and group of the binary to the user and group we created earlier.\nAs soon as we have the NATS server installed, we can create a configuration file and an init script for it:\nCP usr / CMD chmod a+x /usr/local/etc/rc.d/nats The usr directory contains the configuration file and the init script for the NATS server. We’ll copy them to the root directory of the jail and make the init script executable.\nFinally, we’ll set the NATS server to start automatically when the jail boots:\nSYSRC nats_enable=YES SYSRC nats_user=\"${NATS_USER}\" SYSRC nats_group=\"${NATS_GROUP}\" SERVICE nats start Don’t worry too much about the template; you’ll find a link to the repository with the complete code at the end of the article.\nCreating a NATS jail In order to let Bastille create a jail from a template we need to bootstrap it first:\nbastille bootstrap https://github.com/henomis/nats-jail-template This command will download the template from the repository, you’ll find it into the directory /usr/local/bastille/templates/\nNow we can create the jail:\nbastille create nats-jail 14.2-RELEASE 10.0.0.1 This command will create a new jail named nats-jail. The jail will be based on FreeBSD 14.2-RELEASE and will have the IP address 10.0.0.1. It’s time to apply the template:\nbastille template nats-jail henomis/nats-jail-template This command will apply the template to the jail, installing all the necessary packages and configurations. Once the template is applied, you’ll have a fully functional NATS server running in the jail.\nTesting the NATS jail To test the NATS jail, you can connect to it using the NATS CLI tool. But, as we already had fun with jails, we can create a new jails and run the NATS CLI tool in it. We will set up a publisher and a subscriber in two different jails, and we’ll use the NATS server to send messages between them.\nLet’s create a new jail for the publisher:\nbastille create pub-jail 14.2-RELEASE 10.0.0.2 Then we’ll install the necessary packages and the NATS CLI tool:\nbastille pkg pub-jail install -y git go bastille cmd pub-jail go install github.com/nats-io/natscli/nats@latest Thanks to bastille clone we can create a new jail from an existing one, so we can clone the publisher jail and create a subscriber jail:\nbastille clone pub-jail sub-jail 10.0.0.3 bastille start sub-jail We are very close to the end, we just need to start the subscriber and the publisher in two different jails:\nbastille cmd sub-jail /root/go/bin/nats --server 10.0.0.1 sub my.topic Using a different terminal:\nbastille cmd pub-jail /root/go/bin/nats --server 10.0.0.1 pub my.topic \"message {{.Count}} - {{.TimeStamp}}\" --count 5 You should see the messages sent by the publisher in the subscriber terminal.\n[#1] Received on \"my.topic\" message 1 - 2025-01-01T16:20:16+01:00 [#2] Received on \"my.topic\" message 2 - 2025-01-01T16:20:16+01:00 [#3] Received on \"my.topic\" message 3 - 2025-01-01T16:20:16+01:00 [#4] Received on \"my.topic\" message 4 - 2025-01-01T16:20:16+01:00 [#5] Received on \"my.topic\" message 5 - 2025-01-01T16:20:16+01:00 And… that’s it! You have a NATS server running in a FreeBSD jail, and you are able to send messages between different jails using the NATS CLI tool. You can experiment with different configurations, add more jails, and explore the capabilities of NATS and FreeBSD jails further.\nConclusion In this article, we have seen how to create a FreeBSD jail with Bastille and run a NATS server inside it. We have also seen how to create two additional jails and use the NATS CLI tool to send messages between them. This example demonstrates the power and flexibility of FreeBSD jails and how they can be used to create isolated, secure environments for running applications and services.\nYou will find the complete code in the https://github.com/henomis/nats-jail-template repository. Feel free to fork it and experiment with it on your own FreeBSD system. I hope this article has inspired you to explore the world of FreeBSD jails and experiment with different applications and services. Happy hacking!\n","wordCount":"1428","inLanguage":"en","image":"https://simonevellei.com/blog/images/nats001.png","datePublished":"2025-01-01T15:26:03+01:00","dateModified":"2025-01-01T15:26:03+01:00","author":{"@type":"Person","name":"Simone Vellei"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://simonevellei.com/blog/posts/running-nats-on-a-freebsd-jail/"},"publisher":{"@type":"Organization","name":"Simone Vellei Blog","logo":{"@type":"ImageObject","url":"https://simonevellei.com/blog/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://simonevellei.com/blog accesskey=h title="Home (Alt + H)"><img src=https://simonevellei.com/blog/apple-touch-icon.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://linkedin.com/in/simonevellei><img src=/blog/icons/linkedin.png width=32 height=32 style=margin-top:15px></a></li><li><a href=https://www.instagram.com/simone.vellei.agile><img src=/blog/icons/instagram.png width=32 height=32 style=margin-top:15px></a></li><li><a href="https://www.facebook.com/profile.php?id=100086812039299"><img src=/blog/icons/facebook.png width=32 height=32 style=margin-top:15px></a></li><li><a href=https://www.youtube.com/channel/UCbpAhDsXEEnQlRj6skJR5Nw><img src=/blog/icons/youtube.png width=32 height=32 style=margin-top:15px></a></li><li><a href=https://simonevellei.com/blog/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://simonevellei.com title="Simone Vellei"><span>Simone Vellei</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://simonevellei.com/blog>Home</a>&nbsp;»&nbsp;<a href=https://simonevellei.com/blog/posts/>Posts</a></div><h1 class=post-title>Running NATS on a FreeBSD Jail</h1><div class=post-meta><span title='2025-01-01 15:26:03 +0100 +0100'>January 1, 2025</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Simone Vellei</div></header><figure class=entry-cover><img loading=lazy src=https://simonevellei.com/blog/images/nats001.png alt><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-nats aria-label="What is NATS?">What is NATS?</a></li><li><a href=#what-is-a-freebsd-jail aria-label="What is a FreeBSD jail?">What is a FreeBSD jail?</a></li><li><a href=#what-is-bastille aria-label="What is Bastille?">What is Bastille?</a><ul><li><a href=#implementing-a-bastille-template-for-nats aria-label="Implementing a Bastille template for NATS">Implementing a Bastille template for NATS</a></li></ul></li><li><a href=#creating-a-nats-jail aria-label="Creating a NATS jail">Creating a NATS jail</a></li><li><a href=#testing-the-nats-jail aria-label="Testing the NATS jail">Testing the NATS jail</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>Last few months I played with FreeBSD and my Rock64 embedded boards [<a href=https://simonevellei.com/blog/posts/freebsd-on-a-rock64-board/>1</a>] [<a href=https://simonevellei.com/blog/posts/netbsd-on-a-rock64-board/>2</a>]. I really enjoyed the experience and I wanted to go to the next level and experiment with FreeBSD jails. I was surprised how easy (and logical) it was to create and manage an isolated environment. I also noticed that the low level commands have been wrapped into a more user friendly interfaces (like <code>bastille</code>) making the whole experience more enjoyable. To have a real example of a microservice running on a jail, I decided to try with <a href=https://nats.io>NATS</a>.</p><h2 id=what-is-nats>What is NATS?<a hidden class=anchor aria-hidden=true href=#what-is-nats>#</a></h2><p><a href=https://nats.io>NATS</a> is an open-source messaging system that is designed for cloud-native applications, IoT messaging, and microservices architectures. It provides a lightweight, high-performance, and secure communication mechanism that supports both publish-subscribe and request-reply patterns. NATS is known for its simplicity, ease of use, and ability to scale horizontally, making it an ideal choice for distributed systems.</p><p>One of the key features of NATS is its ability to handle high-throughput and low-latency messaging. It achieves this through a combination of efficient protocol design, in-memory data structures, and optimized network communication. NATS also supports clustering, which allows multiple NATS servers to work together to provide fault tolerance and load balancing.</p><p>In addition to its core messaging capabilities, NATS has a rich ecosystem of clients and libraries for various programming languages, making it easy to integrate with different applications and services. It also offers advanced features such as streaming, persistence, and security, which can be leveraged to build robust and reliable messaging solutions.</p><h2 id=what-is-a-freebsd-jail>What is a FreeBSD jail?<a hidden class=anchor aria-hidden=true href=#what-is-a-freebsd-jail>#</a></h2><p>FreeBSD jails are a powerful and flexible feature of the FreeBSD operating system that allow you to create isolated, secure environments within a single FreeBSD instance. Introduced in FreeBSD 4.0, jails provide a lightweight alternative to full virtualization, enabling you to run multiple applications or services in separate, confined spaces without the overhead of a full virtual machine.</p><p>A FreeBSD jail operates as a chroot environment with additional security and resource management features. Each jail has its own filesystem, network interfaces, and process space, ensuring that processes running inside a jail cannot interfere with those in other jails or the host system. This isolation makes jails an excellent choice for securely hosting multiple applications on a single server, testing software in a controlled environment, or managing multi-tenant environments.</p><p>Jails are highly configurable, allowing you to fine-tune the level of isolation and resource allocation for each jail. You can assign specific IP addresses, limit CPU and memory usage, and control access to system resources. This flexibility, combined with the lightweight nature of jails, makes them a popular choice for both development and production environments.</p><h2 id=what-is-bastille>What is Bastille?<a hidden class=anchor aria-hidden=true href=#what-is-bastille>#</a></h2><p><a href=https://bastillebsd.org/>Bastille</a> is a command-line utility for managing FreeBSD jails. It simplifies the process of creating, configuring, and maintaining jails, which are lightweight, isolated environments similar to containers. Bastille provides an easy-to-use interface for jail management, allowing users to quickly deploy and manage applications in a secure and efficient manner.</p><p>With Bastille, you can create new jails, start and stop them, and manage their configurations with simple commands. It also supports templates, which can be used to automate the deployment of pre-configured environments. This makes it an excellent tool for both development and production use cases, where consistency and repeatability are important.</p><p>Bastille also integrates with ZFS, a robust file system that provides advanced features such as snapshots and cloning. This integration allows for efficient storage management and easy rollback of changes, further enhancing the flexibility and reliability of your jail environments.</p><h3 id=implementing-a-bastille-template-for-nats>Implementing a Bastille template for NATS<a hidden class=anchor aria-hidden=true href=#implementing-a-bastille-template-for-nats>#</a></h3><p>Bastille templates are pre-configured environments that can be used to quickly deploy new jails. They contain a base FreeBSD installation along with any additional packages or configurations that you want to include. Templates are a powerful feature of Bastille that can help you streamline your workflow and ensure consistency across your environments.</p><p>The idea is to be architecture agnostic, so the template can be used in any FreeBSD system. NATS will be compiled from source, so the template will contain the necessary packages to build it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># install required packages</span>
</span></span><span style=display:flex><span>PKG git
</span></span><span style=display:flex><span>PKG go
</span></span></code></pre></div><p>Then we can create specific user and group for NATS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># create default group</span>
</span></span><span style=display:flex><span>CMD pw groupadd <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_GROUP<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># create default user</span>
</span></span><span style=display:flex><span>CMD pw useradd -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_USER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -g <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_GROUP<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -s /usr/sbin/nologin -w no
</span></span></code></pre></div><p>We&rsquo;ll accept group and user names as environment variables, so we can customize them when creating the jail from the template.</p><p>Now it&rsquo;s time to clone the NATS repository and compile it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># download and install nats server</span>
</span></span><span style=display:flex><span>CMD <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GO<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> install <span style=color:#e6db74>&#34;github.com/nats-io/nats-server/v2@</span><span style=color:#e6db74>${</span>NATS_VERSION<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>CMD <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>INSTALL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_USER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -g <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_GROUP<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GOPATH<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/nats-server&#34;</span> /usr/local/bin/nats-server
</span></span></code></pre></div><p>We&rsquo;ll use <code>go install</code> to download and compile the NATS server, and then we&rsquo;ll install it in the <code>/usr/local/bin</code> directory. We&rsquo;ll also set the owner and group of the binary to the user and group we created earlier.</p><p>As soon as we have the NATS server installed, we can create a configuration file and an init script for it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CP usr /
</span></span><span style=display:flex><span>CMD chmod a+x /usr/local/etc/rc.d/nats
</span></span></code></pre></div><p>The <code>usr</code> directory contains the configuration file and the init script for the NATS server. We&rsquo;ll copy them to the root directory of the jail and make the init script executable.</p><p>Finally, we&rsquo;ll set the NATS server to start automatically when the jail boots:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SYSRC nats_enable<span style=color:#f92672>=</span>YES
</span></span><span style=display:flex><span>SYSRC nats_user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_USER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>SYSRC nats_group<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>NATS_GROUP<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>SERVICE nats start
</span></span></code></pre></div><blockquote><p>Don&rsquo;t worry too much about the template; you&rsquo;ll find a link to the repository with the complete code at the end of the article.</p></blockquote><h2 id=creating-a-nats-jail>Creating a NATS jail<a hidden class=anchor aria-hidden=true href=#creating-a-nats-jail>#</a></h2><p>In order to let Bastille create a jail from a template we need to bootstrap it first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille bootstrap https://github.com/henomis/nats-jail-template
</span></span></code></pre></div><p>This command will download the template from the repository, you&rsquo;ll find it into the directory <code>/usr/local/bastille/templates/</code></p><p>Now we can create the jail:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille create nats-jail 14.2-RELEASE 10.0.0.1
</span></span></code></pre></div><p>This command will create a new jail named <code>nats-jail</code>. The jail will be based on FreeBSD 14.2-RELEASE and will have the IP address <code>10.0.0.1</code>. It&rsquo;s time to apply the template:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille template nats-jail henomis/nats-jail-template
</span></span></code></pre></div><p>This command will apply the template to the jail, installing all the necessary packages and configurations. Once the template is applied, you&rsquo;ll have a fully functional NATS server running in the jail.</p><h2 id=testing-the-nats-jail>Testing the NATS jail<a hidden class=anchor aria-hidden=true href=#testing-the-nats-jail>#</a></h2><p>To test the NATS jail, you can connect to it using the NATS CLI tool. But, as we already had fun with jails, we can create a new jails and run the NATS CLI tool in it. We will set up a publisher and a subscriber in two different jails, and we&rsquo;ll use the NATS server to send messages between them.</p><p>Let&rsquo;s create a new jail for the publisher:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille create pub-jail 14.2-RELEASE 10.0.0.2
</span></span></code></pre></div><p>Then we&rsquo;ll install the necessary packages and the NATS CLI tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille pkg pub-jail install -y git go
</span></span><span style=display:flex><span>bastille cmd pub-jail go install github.com/nats-io/natscli/nats@latest
</span></span></code></pre></div><p>Thanks to <code>bastille clone</code> we can create a new jail from an existing one, so we can clone the publisher jail and create a subscriber jail:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille clone pub-jail sub-jail 10.0.0.3
</span></span><span style=display:flex><span>bastille start sub-jail
</span></span></code></pre></div><p>We are very close to the end, we just need to start the subscriber and the publisher in two different jails:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille cmd sub-jail /root/go/bin/nats --server 10.0.0.1 sub my.topic
</span></span></code></pre></div><p>Using a different terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bastille cmd pub-jail /root/go/bin/nats --server 10.0.0.1 pub my.topic <span style=color:#e6db74>&#34;message {{.Count}} - {{.TimeStamp}}&#34;</span> --count <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>You should see the messages sent by the publisher in the subscriber terminal.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#75715e>#1] Received on &#34;my.topic&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#ae81ff>1</span> - 2025-01-01T16:20:16+01:00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#75715e>#2] Received on &#34;my.topic&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#ae81ff>2</span> - 2025-01-01T16:20:16+01:00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#75715e>#3] Received on &#34;my.topic&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#ae81ff>3</span> - 2025-01-01T16:20:16+01:00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#75715e>#4] Received on &#34;my.topic&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#ae81ff>4</span> - 2025-01-01T16:20:16+01:00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#75715e>#5] Received on &#34;my.topic&#34;</span>
</span></span><span style=display:flex><span>message <span style=color:#ae81ff>5</span> - 2025-01-01T16:20:16+01:00
</span></span></code></pre></div><p>And&mldr; that&rsquo;s it! You have a NATS server running in a FreeBSD jail, and you are able to send messages between different jails using the NATS CLI tool. You can experiment with different configurations, add more jails, and explore the capabilities of NATS and FreeBSD jails further.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this article, we have seen how to create a FreeBSD jail with Bastille and run a NATS server inside it. We have also seen how to create two additional jails and use the NATS CLI tool to send messages between them. This example demonstrates the power and flexibility of FreeBSD jails and how they can be used to create isolated, secure environments for running applications and services.</p><p>You will find the complete code in the <a href=https://github.com/henomis/nats-jail-template>https://github.com/henomis/nats-jail-template</a> repository. Feel free to fork it and experiment with it on your own FreeBSD system. I hope this article has inspired you to explore the world of FreeBSD jails and experiment with different applications and services. Happy hacking!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://simonevellei.com/blog/tags/nats/>nats</a></li><li><a href=https://simonevellei.com/blog/tags/freebsd/>freebsd</a></li><li><a href=https://simonevellei.com/blog/tags/jail/>jail</a></li><li><a href=https://simonevellei.com/blog/tags/bastille/>bastille</a></li><li><a href=https://simonevellei.com/blog/tags/go/>go</a></li></ul><nav class=paginav><a class=prev href=https://simonevellei.com/blog/posts/referendum-2025/><span class=title>« Prev Page</span><br><span>Referendum 2025, la parola ai dati</span></a>
<a class=next href=https://simonevellei.com/blog/posts/3-anni-da-remoto-12-lezioni-imparate/><span class=title>Next Page »</span><br><span>3 anni da remoto, 12 lezioni imparate</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on twitter" href="https://twitter.com/intent/tweet/?text=Running%20NATS%20on%20a%20FreeBSD%20Jail&amp;url=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f&amp;hashtags=nats%2cfreebsd%2cjail%2cbastille%2cgo"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f&amp;title=Running%20NATS%20on%20a%20FreeBSD%20Jail&amp;summary=Running%20NATS%20on%20a%20FreeBSD%20Jail&amp;source=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f&title=Running%20NATS%20on%20a%20FreeBSD%20Jail"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on whatsapp" href="https://api.whatsapp.com/send?text=Running%20NATS%20on%20a%20FreeBSD%20Jail%20-%20https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Running NATS on a FreeBSD Jail on telegram" href="https://telegram.me/share/url?text=Running%20NATS%20on%20a%20FreeBSD%20Jail&amp;url=https%3a%2f%2fsimonevellei.com%2fblog%2fposts%2frunning-nats-on-a-freebsd-jail%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://simonevellei.com/blog>Simone Vellei Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>